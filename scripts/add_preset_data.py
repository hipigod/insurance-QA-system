"""
直接插入预设数据到数据库
"""
import asyncio
import sys
import os

# 添加backend目录到Python路径
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'backend'))

from sqlalchemy.ext.asyncio import AsyncSession
from app.core.database import AsyncSessionLocal, init_db
from app.models.models import CustomerRole, InsuranceProduct, ScoringDimension


async def add_roles():
    """添加客户角色"""
    print("\n=== 添加客户角色 ===")

    roles = [
        CustomerRole(
            name="小白客户",
            description="对保险了解不多，需要耐心解释",
            difficulty="简单",
            system_prompt="""你是一个对保险了解不多的普通客户。

【性格特征】
性格温和，对保险产品了解有限，容易被专业术语弄糊涂。
对销售人员比较信任，但需要简单易懂的解释。

【背景情况】
- 年龄：35岁，已婚有一子
- 职业：公司职员，收入稳定
- 保险需求：想给孩子买教育金，但对保险不了解

【对话特点】
- 会问很多基础问题："什么是保险？"、"保险有用吗？"
- 需要用生活化的语言解释，避免专业术语
- 对价格敏感，需要性价比高的产品
- 容易被说服，只要解释清楚

【异议类型】
1. 不理解保险的作用："保险不就是骗人的吗？"
2. 担心保费太贵："这个保费太贵了，我负担不起"
3. 犹豫不决："我回家和爱人商量一下"
4. 信任问题："你们保险公司靠谱吗？"

【评分重点】
销售人员是否能够：
- 用简单的语言解释保险概念
- 建立信任关系
- 消除客户的疑虑
- 推荐适合的性价比产品"""
        ),
        CustomerRole(
            name="理性分析型",
            description="注重数据对比，需要详细说明",
            difficulty="中等",
            system_prompt="""你是一个理性、注重数据分析的客户。

【性格特征】
逻辑思维强，喜欢对比分析，不会被轻易说服。
对保险有一定了解，会深入研究产品细节。

【背景情况】
- 年龄：40岁，硕士学历
- 职业：IT行业技术总监，收入较高
- 保险需求：给自己配置全面保障，重疾险+寿险+医疗险

【对话特点】
- 会详细询问产品条款、保障范围、理赔条件
- 会对比多家公司的产品
- 要求销售人员用数据说话，不要只讲概念
- 关注IRR（内部收益率）、现金价值等财务指标

【异议类型】
1. 质疑保障范围："这个病为什么不保？"
2. 对比竞品："XX公司的产品比你们好"
3. 怀疑销售夸大："你说的这些真的能兑现吗？"
4. 要求透明化："把合同条款给我看清楚"

【评分重点】
销售人员是否能够：
- 准确回答产品细节问题
- 提供数据支持（IRR、现金价值表等）
- 诚实说明产品的优势和局限
- 展现专业知识和素养"""
        ),
        CustomerRole(
            name="价格敏感型",
            description="预算有限，需要高性价比产品",
            difficulty="困难",
            system_prompt="""你是一个价格敏感、预算有限的客户。

【性格特征】
精打细算，对每一分钱都很在意。
认为保险是"可有可无"的支出，能省则省。

【背景情况】
- 年龄：30岁，单身
- 职业：普通工人，月收入5000元
- 保险需求：想买保险但预算有限，月预算不超过300元

【对话特点】
- 一上来就问价格："多少钱一年？"
- 会反复砍价："能不能便宜点？"
- 质疑保险的必要性："我没钱买保险"
- 喜欢对比不同产品的价格

【异议类型】
1. 觉得保费太贵："太贵了，我买不起"
2. 质疑性价比："这么贵能保障什么？"
3. 推迟购买："等我有钱了再买"
4. 怀疑被宰："你是不是在坑我钱？"

【评分重点】
销售人员是否能够：
- 理解客户的预算限制
- 推荐高性价比的入门产品
- 用分期缴费减轻压力
- 说明保险的长期价值和必要性"""
        ),
        CustomerRole(
            name="怀疑抗拒型",
            description="对保险行业有偏见，需要建立信任",
            difficulty="困难",
            system_prompt="""你是一个对保险行业有强烈偏见的客户。

【性格特征】
固执己见，对保险行业非常不信任。
曾经听说或经历过保险理赔失败的案例。

【背景情况】
- 年龄：45岁
- 职业：个体经营
- 保险需求：其实需要保险，但因为偏见而抗拒

【对话特点】
- 态度冷淡，甚至带有敌意
- 经常打断销售人员的话
- 质疑保险公司的诚信："买时容易理赔难"
- 引用负面案例："我朋友买了保险都没赔"

【异议类型】
1. 行业偏见："保险公司都是骗子"
2. 理赔质疑："到时候肯定不赔钱"
3. 不信任销售："你们就会忽悠人"
4. 过往阴影："我之前被骗过"
5. 认为保险不划算："存银行比买保险强"

【评分重点】
销售人员是否能够：
- 保持耐心和同理心
- 不与客户争辩，先认同后引导
- 用真实案例改变客户认知
- 展现专业和诚信
- 逐步建立信任关系"""
        )
    ]

    async with AsyncSessionLocal() as session:
        for role in roles:
            try:
                session.add(role)
                await session.commit()
                print(f"[OK] Created role: {role.name}")
            except Exception as e:
                await session.rollback()
                print(f"[ERROR] Failed to create role: {role.name} - {e}")


async def add_products():
    """添加保险产品"""
    print("\n=== 添加保险产品 ===")

    products = [
        InsuranceProduct(
            name="少儿教育金保险",
            description="为孩子未来教育储备资金，兼顾保障",
            product_type="教育金",
            coverage="教育金+身故保障+保费豁免",
            premium_range="5000-20000元/年",
            target_audience="0-12岁儿童的父母",
            detailed_info="""【产品特点】
1. 专款专用：确保孩子未来教育资金
2. 保费豁免：父母身故/全残免交后续保费
3. 灵活领取：高中、大学、创业多个阶段可领取
4. 复利增值：现金价值逐年增长

【保障责任】
- 教育金：18-21岁每年领取大学教育金
- 满期金：22岁一次性领取创业金
- 身故保障：赔付已交保费或现金价值较大者
- 保费豁免：投保人身故/全残豁免后续保费

【适用人群】
- 孕期准父母
- 0-12岁儿童的父母
- 重视子女教育的家庭

【销售要点】
- 强调"专款专用"的教育金属性
- 突出保费豁免功能的重要性
- 说明早期投保的优势（保费低、积累期长）
- 可对比银行教育储蓄的收益"""
        ),
        InsuranceProduct(
            name="终身重大疾病保险",
            description="覆盖100+种重疾，确诊即赔",
            product_type="重疾险",
            coverage="100+种重疾+20+种中症+40+种轻症+身故保障",
            premium_range="3000-15000元/年",
            target_audience="18-55岁健康人群",
            detailed_info="""【产品特点】
1. 覆盖广：100+种重疾，20+种中症，40+种轻症
2. 确诊即赔：不限制用途，自由支配
3. 终身保障：保障至终身，无年龄限制
4. 多次赔付：重疾可多次赔付（可选）

【保障责任】
- 重疾保险金：100种重疾，赔付100%保额
- 中症保险金：20种中症，赔付60%保额
- 轻症保险金：40种轻症，赔付30%保额
- 身故保险金：18岁后赔付100%保额
- 豁免保费：患轻症/中症后豁免后续保费

【适用人群】
- 家庭经济支柱
- 健康状况良好的人群
- 需要长期保障的人群

【销售要点】
- 强调重疾高发性和年轻化趋势
- 说明"收入损失"比医疗费用更严重
- 突出确诊即赔、不限用途的优势
- 年轻时投保保费更低、更容易通过核保
- 可附加医疗险、意外险完善保障"""
        ),
        InsuranceProduct(
            name="定期寿险",
            description="低保费高保障，家庭责任必备",
            product_type="寿险",
            coverage="身故/全残保障",
            premium_range="500-3000元/年",
            target_audience="20-50岁家庭经济支柱",
            detailed_info="""【产品特点】
1. 保费低：杠杆高，几百元撬动百万保障
2. 保障高：最高可达200万保额
3. 期限灵活：可选10/20/30年或保至60/70岁
4. 纯保障：无理财成分，专注保障

【保障责任】
- 身故保险金：赔付100%保额
- 全残保险金：赔付100%保额
- 免责条款：极少（仅3条免责）

【适用人群】
- 家庭经济支柱（上有老下有小）
- 房贷/车贷压力的家庭
- 刚步入社会的年轻人
- 保费预算有限的人群

【销售要点】
- 强调"家庭责任"：如果不幸发生，留爱不留债
- 对比房贷：寿险保额至少覆盖房贷余额
- 对比收入：寿险保额至少是年收入的5-10倍
- 强调低保费高保障的杠杆效应
- 说明定期寿险最适合中青年时期"""
        )
    ]

    async with AsyncSessionLocal() as session:
        for product in products:
            try:
                session.add(product)
                await session.commit()
                print(f"[OK] Created product: {product.name}")
            except Exception as e:
                await session.rollback()
                print(f"[ERROR] Failed to create product: {product.name} - {e}")


async def add_dimensions():
    """添加评分维度"""
    print("\n=== 添加评分维度 ===")

    dimensions = [
        ScoringDimension(
            name="需求挖掘",
            description="是否准确了解客户真实需求和担忧",
            weight=20,
            evaluation_prompt="""请评估销售人员在"需求挖掘"维度的表现：

【评估标准】
1. 提问质量（25分）
   - 是否提出开放式问题了解客户情况
   - 是否深入挖掘客户的真实需求
   - 是否了解客户的家庭结构、经济状况等

2. 倾听能力（25分）
   - 是否认真倾听客户的回答
   - 是否根据客户反馈调整沟通策略
   - 是否捕捉到客户的隐性需求

3. 需求确认（25分）
   - 是否总结并确认客户的需求
   - 是否找到客户最关注的问题点
   - 是否理解客户的核心痛点

4. 针对性推荐（25分）
   - 推荐的产品是否符合客户需求
   - 是否说明产品如何解决客户问题
   - 保额、保费是否匹配客户预算

【评分参考】
- 优秀（90-100分）：全面深入挖掘需求，精准推荐
- 良好（80-89分）：较好了解需求，推荐较准确
- 中等（70-79分）：基本了解需求，推荐基本匹配
- 较差（60-69分）：需求挖掘不深入，推荐针对性不强
- 差（<60分）：未了解需求就开始推销

请给出0-100的分数，并简要说明评分理由。"""
        ),
        ScoringDimension(
            name="产品说明",
            description="产品介绍是否准确、清晰、易懂",
            weight=25,
            evaluation_prompt="""请评估销售人员在"产品说明"维度的表现：

【评估标准】
1. 准确性（30分）
   - 产品介绍是否准确无误
   - 是否如实说明保障范围和免责条款
   - 是否夸大或误导性宣传

2. 清晰度（30分）
   - 是否用通俗易懂的语言解释产品
   - 是否避免使用过多专业术语
   - 逻辑是否清晰，重点是否突出

3. 针对性（20分）
   - 是否突出客户最关心的功能
   - 是否说明产品如何满足客户需求
   - 是否对比其他产品的优势

4. 证据支持（20分）
   - 是否提供数据、案例等支持
   - 是否展示产品条款、计划书
   - 是否用可视化方式说明

【评分参考】
- 优秀（90-100分）：准确清晰，深入浅出，重点突出
- 良好（80-89分）：介绍准确，表达清晰
- 中等（70-79分）：基本准确，但不够清晰
- 较差（60-69分）：有错误或含糊不清
- 差（<60分）：严重错误或误导客户

请给出0-100的分数，并简要说明评分理由。"""
        ),
        ScoringDimension(
            name="异议处理",
            description="是否有效化解客户疑虑和反对意见",
            weight=25,
            evaluation_prompt="""请评估销售人员在"异议处理"维度的表现：

【评估标准】
1. 情绪管理（25分）
   - 面对异议是否保持耐心和友善
   - 是否不与客户争辩或对立
   - 是否展现出同理心

2. 异议识别（25分）
   - 是否准确理解客户异议的真实原因
   - 是否识别出表面的借口背后的真实担忧
   - 是否区分真实异议和虚假异议

3. 处理技巧（30分）
   - 是否使用"认同-转化"技巧
   - 是否用案例、数据等说服客户
   - 是否采用提问引导客户自我说服
   - 是否有效化解客户疑虑

4. 效果评估（20分）
   - 客户异议是否得到有效解决
   - 客户是否从反对转为接受
   - 是否增强了客户信任

【评分参考】
- 优秀（90-100分）：巧妙化解异议，甚至化反对为支持
- 良好（80-89分）：有效处理异议，客户疑虑基本消除
- 中等（70-79分）：基本处理异议，但效果一般
- 较差（60-69分）：处理方式生硬，效果不佳
- 差（<60分）：与客户争辩或无法回应异议

请给出0-100的分数，并简要说明评分理由。"""
        ),
        ScoringDimension(
            name="促成能力",
            description="是否能有效引导客户完成购买决策",
            weight=30,
            evaluation_prompt="""请评估销售人员在"促成能力"维度的表现：

【评估标准】
1. 时机把握（25分）
   - 是否准确判断客户的购买信号
   - 是否在合适的时机提出促成
   - 是否不急于求成也不拖延时机

2. 促成技巧（35分）
   - 是否使用假设成交法："如果没问题，我们今天办理？"
   - 是否使用二择一法："您想年交还是季交？"
   - 是否利用稀缺性："这个优惠政策月底结束"
   - 是否总结价值强化购买决心

3. 临门一脚（25分）
   - 是否有效化解最后的犹豫
   - 是否给客户信心和安全感
   - 是否简化投保流程

4. 专业性（15分）
   - 是否展现专业素养
   - 是否让客户感到值得信赖
   - 是否提供良好的服务体验

【评分参考】
- 优秀（90-100分）：自然促成，水到渠成，客户愉快接受
- 良好（80-89分）：有效促成，客户愿意购买
- 中等（70-79分）：基本促成，但有些勉强
- 较差（60-69分）：促成时机不当或技巧生硬
- 差（<60分）：未能促成或引起客户反感

请给出0-100的分数，并简要说明评分理由。"""
        )
    ]

    async with AsyncSessionLocal() as session:
        for dimension in dimensions:
            try:
                session.add(dimension)
                await session.commit()
                print(f"[OK] Created dimension: {dimension.name}")
            except Exception as e:
                await session.rollback()
                print(f"[ERROR] Failed to create dimension: {dimension.name} - {e}")


async def main():
    """主函数"""
    try:
        print("=" * 60)
        print("Insurance Sales Practice System - Adding Preset Data")
        print("=" * 60)

        await add_roles()
        await add_products()
        await add_dimensions()

        print("\n" + "=" * 60)
        print("[OK] All preset data added successfully!")
        print("=" * 60)
        print("\nYou can now start using the system!")
        print("Frontend: http://localhost:5173")
        print("Admin: http://localhost:5173/#/admin")

    except Exception as e:
        print(f"\n[ERROR] Error occurred: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(main())
